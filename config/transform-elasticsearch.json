{
  "documents": [
    {
      "document-name": "datadiscovery",
      "source-entity": "germplasm",
      "copy-fields-from-source": false,

      "document-transform": {
        "@type": "Germplasm",
        "@id": "{.germplasmPUI}",
        "schema:includedInDataCatalog": "{.source}",
        "schema:identifier": "{.germplasmDbId}",
        "schema:name": {
          "{or}": [
            "{.defaultDisplayName}",
            "{.germplasmName}",
            "{.accessionNumber}"
          ]
        },
        "schema:url": "{.url}",
        "schema:description": {
          "{join}": [
            "'{.germplasmName}' is a",
            {
              "{if}": "{.commonCropName}",
              "{then}": " {.commonCropName} accession",
              "{else}": "n accession"
            },
            {
              "{if}": "{.genus + .species + .subtaxa}",
              "{then}": " ({.genus + .species + .subtaxa})"
            },
            {
              "{if}": "{.accessionNumber}",
              "{then}": " with number: '{.accessionNumber}'"
            },
            ". {.comment}"
          ]
        },
        "germplasm": {
          "facet": {
            "commonCropName": "{.commonCropName}",
            "species": "{.genus + .species}"
          },
          "search": {
            "cropName": {
              "{flatten}": [
                "{.commonCropName}",
                "{.taxonCommonNames}",
                "{.genus}",
                "{.genus + .species}",
                "{.genus + .species + .subtaxa}",
                "{.taxonSynonyms}"
              ]
            },
            "germplasmList": {
              "{flatten}": [
                "{.panel.name}",
                "{.collection.name}",
                "{.population.name}",
                "{.holdingGenbank.instituteName}"
              ]
            },
            "accession": {
              "{flatten}": [
                "{.germplasmName}",
                "{.defaultDisplayName}",
                "{.accessionNumber}",
                "{.synonyms}"
              ]
            }
          }
        },
        "trait": {
          "facet": {
            "observationVariableIds": {
              "{flatten}": [
                "{.studyPUIs => .observationVariablePUIs}"
              ]
            }
          }
        },
        "study": {
          "facet": {
            "dataSet": {
              "{flatten}": [
                "{.studyPUIs => .trialPUIs => .trialName}"
              ]
            },
            "location": {
              "{flatten}": [
                "{.studyPUIs => .locationPUIs => .locationName}",
                "{.studyPUIs => .locationPUIs => .countryName}"
              ]
            }
          }
        }
      }
    },
    {
      "document-name": "datadiscovery",
      "source-entity": "study",
      "copy-fields-from-source": false,

      "document-transform": {
        "@type": [
          "Study",
          "{.thematicType}"
        ],
        "@id": "{.studyPUI}",
        "schema:includedInDataCatalog": "{.source}",
        "schema:identifier": "{.studyDbId}",
        "schema:name": {
          "{or}": [
            "{.studyName}",
            "{.name}"
          ]
        },
        "schema:url": "{.url}",
        "schema:description": {
          "{join}": [
            "'{.studyName}' is a study",
            {
              "{if}": "{.locationPUIs => .locationName}",
              "{then}": [
                " located in {locationPUIs => .locationName}",
                {
                  "{if}": "{.locationPUIs => .countryName}",
                  "{then}": " ({.locationPUIs => .countryName})"
                }
              ]
            },
            ". {.studyDescription}"
          ]
        },
        "germplasm": {
          "facet": {
            "commonCropName": "{.germplasmPUIs => .commonCropName}",
            "species": "{.germplasmPUIs => .genus + .species}"
          },
          "search": {
            "cropName": {
              "{flatten}": [
                "{.germplasmPUIs => .commonCropName}",
                "{.germplasmPUIs => .taxonCommonNames}",
                "{.germplasmPUIs => .genus}",
                "{.germplasmPUIs => .genus + .species}",
                "{.germplasmPUIs => .genus + .species + .subtaxa}",
                "{.germplasmPUIs => .taxonSynonyms}"
              ]
            },
            "germplasmList": {
              "{flatten}": [
                "{.germplasmPUIs => .panel.name}",
                "{.germplasmPUIs => .collection.name}",
                "{.germplasmPUIs => .population.name}",
                "{.germplasmPUIs => .holdingGenbank.instituteName}"
              ]
            },
            "accession": {
              "{flatten}": [
                "{.germplasmPUIs => .germplasmName}",
                "{.germplasmPUIs => .defaultDisplayName}",
                "{.germplasmPUIs => .accessionNumber}",
                "{.germplasmPUIs => .synonyms}"
              ]
            }
          }
        },
        "trait": {
          "facet": {
            "observationVariableIds": {
              "{flatten}": [
                "{.studPUIs => .observationVariablePUIs}"
              ]
            }
          }
        },
        "study": {
          "facet": {
            "dataSet": {
              "{flatten}": [
                "{.trialPUIs => .trialName}"
              ]
            },
            "location": {
              "{flatten}": [
                "{.locationPUIs => .locationName}",
                "{.locationPUIs => .countryName}"
              ]
            }
          }
        }
      }
    },
    {
      "document-name": "germplasm",
      "source-entity": "germplasm",
      "copy-fields-from-source": true,

      "document-transform": {
        "germplasmName": {
          "{or}": [
            "{.germplasmName}",
            "{.defaultDisplayName}",
            "{.accessionNumber}"
          ]
        },
        "defaultDisplayName": {
          "{or}": [
            "{.defaultDisplayName}",
            "{.germplasmName}",
            "{.accessionNumber}"
          ]
        }
      }
    },
    {
      "document-name": "study",
      "source-entity": "study",
      "copy-fields-from-source": true,

      "document-transform": {
        "studyName": {
          "{or}": [
            "{.studyName}",
            "{.name}"
          ]
        },
        "contacts": "{.contactPUIs => .}"
      }
    },
    {
      "document-name": "trial",
      "source-entity": "trial",
      "copy-fields-from-source": true,

      "document-transform": {
        "trialName": {
          "{or}": [
            "{.trialName}",
            "{.name}"
          ]
        },
        "studies": "{.studyPUIs => .}",
        "contacts": "{.contactPUIs => .}"
      }
    },
    {
      "document-name": "location",
      "source-entity": "location",
      "copy-fields-from-source": true,

      "document-transform": {
        "locationName": {
          "{or}": [
            "{.locationName}",
            "{.name}"
          ]
        },
        "instituteAddress": {
          "{or}": [
            "{.instituteAddress}",
            "{.instituteAdress}"
          ]
        },
        "abbreviation": {
          "{or}": [
            "{.abbreviation}",
            "{.abreviation}"
          ]
        }
      }
    },
    {
      "document-name": "program",
      "source-entity": "program",
      "copy-fields-from-source": true,

      "document-transform": {
        "programName": {
          "{or}": [
            "{.programName}",
            "{.name}"
          ]
        }
      }
    }
  ],

  "validation": {
    "documents": {

      "datadiscovery": {
        "type": "object",
        "properties": {
          "@id": {
            "type": "string",
            "format": "uri"
          },
          "@type": {"$ref": "#/definitions/es-strings"},
          "schema:name": {
            "type": "string"
          },
          "schema:url": {
            "type": "string",
            "format": "url"
          },
          "schema:includedInDataCatalog": {
            "type": "string",
            "format": "uri"
          }
        },
        "required": [
          "@id",
          "@type",
          "schema:name",
          "schema:includedInDataCatalog"
        ]
      },

      "trial": {
        "type": "object",
        "properties": {
          "trialDbId": {"$ref": "#/definitions/es-string"},
          "trialName": {"$ref": "#/definitions/es-string"}
        },
        "required": ["trialDbId", "trialName"]
      },

      "study": {
        "type": "object",
        "properties": {
          "studyDbId": {"$ref": "#/definitions/es-string"},
          "studyName": {"$ref": "#/definitions/es-string"}
        },
        "required": ["studyDbId", "studyName"]
      },

      "germplasm": {
        "type": "object",
        "properties": {
          "germplasmDbId": {"$ref": "#/definitions/es-string"},
          "germplasmName": {"$ref": "#/definitions/es-string"}
        },
        "required": ["germplasmDbId", "germplasmName"]
      },

      "location": {
        "type": "object",
        "properties": {
          "locationDbId": {"$ref": "#/definitions/es-string"},
          "locationName": {"$ref": "#/definitions/es-string"}
        },
        "required": ["locationDbId", "locationName"]
      },

      "program": {
        "type": "object",
        "properties": {
          "programDbId": {"$ref": "#/definitions/es-string"},
          "programName": {"$ref": "#/definitions/es-string"}
        },
        "required": ["programDbId", "programName"]
      }
    },

    "base-definitions": {
        "es-string": {
            "comment": "Elasticsearch accepts numbers as string with automatic conversion",
            "type": ["number", "string"]
        },
        "es-strings": {
            "comment": "Elasticsearch does not discriminate between a single string or an array of strings",
            "anyOf": [
                {
                    "type": "array",
                    "items": {"$ref": "#/definitions/es-string"}
                },
                {"$ref": "#/definitions/es-string"}
            ]
        }
    }
  }
}